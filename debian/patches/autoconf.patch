Goal: move changes to autogenerated files into their own patch now that we've
      lost the script that was calling autogen.sh for us; this also helps
      make debian/rules clean just a little bit cleaner.

Fixes: no specific bug

Status wrt upstream: Debian specific

Note: This patch will normally have to be updated by hand after every
      new upstream release and after updates of any other patches that
      touch configure.in -- the first because configure scripts don't
      hold patches well between updates, the second so that our changes
      are recognized in the version of the script actually used in the
      build process.

      The process for refreshing this patch is:

 export QUILT_PATCHES=debian/patches
 quilt push autoconf.patch # to get everything applied up to this point
 quilt push -f autoconf.patch # to override the errors when applying
 (cd source && autoconf -I m4 -I lib/replace)
   # the -I lib/replace is needed because upstream seems to have done
   # something screwy with where their m4 include files are distributed in the
   # source tree; so this option may not be necessary in the future
 quilt refresh
 find . -name '*.rej' | xargs rm

Index: samba-3.3.0rc1/source/configure
===================================================================
--- samba-3.3.0rc1.orig/source/configure
+++ samba-3.3.0rc1/source/configure
@@ -791,6 +791,7 @@
 LIBTALLOC_SHARED
 LIBTALLOC_STATIC
 LIBTALLOC_LIBS
+LIBTALLOC_TARGET
 INSTALL_LIBTALLOC
 UNINSTALL_LIBTALLOC
 LIBTALLOC_SOVER
@@ -799,6 +800,7 @@
 LIBTDB_SHARED
 LIBTDB_STATIC
 LIBTDB_LIBS
+LIBTDB_TARGET
 INSTALL_LIBTDB
 UNINSTALL_LIBTDB
 LIBTDB_SOVER
@@ -807,6 +809,7 @@
 LIBNETAPI_SHARED
 LIBNETAPI_STATIC
 LIBNETAPI_LIBS
+LIBNETAPI_TARGET
 INSTALL_LIBNETAPI
 UNINSTALL_LIBNETAPI
 LIBNETAPI_SOVER
@@ -815,6 +818,7 @@
 LIBSMBCLIENT_SHARED
 LIBSMBCLIENT_STATIC
 LIBSMBCLIENT_LIBS
+LIBSMBCLIENT_TARGET
 INSTALL_LIBSMBCLIENT
 UNINSTALL_LIBSMBCLIENT
 LIBSMBCLIENT_SOVER
@@ -823,6 +827,7 @@
 LIBSMBSHAREMODES_SHARED
 LIBSMBSHAREMODES_STATIC
 LIBSMBSHAREMODES_LIBS
+LIBSMBSHAREMODES_TARGET
 INSTALL_LIBSMBSHAREMODES
 UNINSTALL_LIBSMBSHAREMODES
 LIBSMBSHAREMODES_SOVER
@@ -831,6 +836,7 @@
 LIBADDNS_SHARED
 LIBADDNS_STATIC
 LIBADDNS_LIBS
+LIBADDNS_TARGET
 INSTALL_LIBADDNS
 UNINSTALL_LIBADDNS
 LIBADDNS_SOVER
@@ -2243,9 +2249,9 @@
 pammodulesdir="${libdir}/security"
 configdir="${libdir}"
 swatdir="\${prefix}/swat"
-codepagedir="\${MODULESDIR}"
-statedir="\${LOCKDIR}"
-cachedir="\${prefix}/cache/samba"
+codepagedir="\${prefix}/share/samba"
+statedir="\${VARDIR}/lib/samba"
+cachedir="\${VARDIR}/cache/samba"
 localedir="\${prefix}/share/locale"
 
 
@@ -2261,10 +2267,10 @@
     test "${libdir}" || libdir="\${prefix}/lib"
     modulesdir="${libdir}/samba"
     configdir="\${sysconfdir}/samba"
-    swatdir="\${DATADIR}/samba/swat"
+    swatdir="\${prefix}/swat"
     codepagedir="\${prefix}/share/samba"
     statedir="\${VARDIR}/lib/samba"
-    cachedir="\${VARDIR}/lib/samba"
+    cachedir="\${VARDIR}/cache/samba"
 
 cat >>confdefs.h <<\_ACEOF
 #define FHS_COMPATIBLE 1
@@ -13110,6 +13116,27 @@
       fi
     ;;
 
+# Systems with LFS support.
+#
+    gnu* | k*bsd*-gnu)
+	CPPFLAGS="-D_LARGEFILE64_SOURCE -D_FILE_OFFSET_BITS=64 -D_GNU_SOURCE $CPPFLAGS"
+
+cat >>confdefs.h <<\_ACEOF
+#define _LARGEFILE64_SOURCE 1
+_ACEOF
+
+
+cat >>confdefs.h <<\_ACEOF
+#define _FILE_OFFSET_BITS 64
+_ACEOF
+
+
+cat >>confdefs.h <<\_ACEOF
+#define _GNU_SOURCE 1
+_ACEOF
+
+	;;
+
 # Tests for linux LFS support. Need kernel 2.4 and glibc2.2 or greater support.
 #
     *linux*)
@@ -41166,7 +41193,7 @@
 #
 #
 case "$host_os" in
-    *linux*)
+    linux*-gnu* | gnu* | k*bsd*-gnu)
        # glibc <= 2.3.2 has a broken getgrouplist
        if test "$cross_compiling" = yes; then
   { { echo "$as_me:$LINENO: error: cannot run test program while cross compiling
@@ -46402,11 +46429,14 @@
 
   # and these are for particular systems
   case "$host_os" in
-		*linux*)
+		linux*-gnu* | gnu* | k*bsd*-gnu)
+			case "$host_os" in linux*)
+
 cat >>confdefs.h <<\_ACEOF
 #define LINUX 1
 _ACEOF
-
+ ;;
+			esac
 			BLDSHARED="true"
 			if test "${ac_cv_gnu_ld_no_default_allow_shlib_undefined}" = "yes"; then
 				LDSHFLAGS="-shared -Wl,-Bsymbolic -Wl,--allow-shlib-undefined"
@@ -67596,7 +67626,8 @@
 LIBTALLOC_STATIC_TARGET=bin/libtalloc.a
 LIBTALLOC_SHARED=
 LIBTALLOC_STATIC=
-LIBTALLOC_LIBS=
+LIBTALLOC_LIBS=-ltalloc
+LIBTALLOC_TARGET=
 INSTALL_LIBTALLOC=
 UNINSTALL_LIBTALLOC=
 
@@ -67611,6 +67642,7 @@
 
 
 
+
 { echo "$as_me:$LINENO: checking whether to build the libtalloc shared library" >&5
 echo $ECHO_N "checking whether to build the libtalloc shared library... $ECHO_C" >&6; }
 
@@ -67645,15 +67677,17 @@
 	UNINSTALL_LIBTALLOC=uninstalllibtalloc
 	if eval $BLDSHARED = true; then
 		LIBTALLOC_SHARED=$LIBTALLOC_SHARED_TARGET
+		LIBTALLOC_TARGET=$LIBTALLOC_SHARED_TARGET
 		{ echo "$as_me:$LINENO: result: yes" >&5
 echo "${ECHO_T}yes" >&6; }
 		if test x"$USESHARED" != x"true" -o x"$LINK_LIBTALLOC" = "xSTATIC" ; then
 			enable_static=yes
-		else
-			LIBTALLOC_LIBS=-ltalloc
+			LIBTALLOC_TARGET=$LIBTALLOC_STATIC_TARGET
+			LIBTALLOC_LIBS=$LIBTALLOC_STATIC_TARGET
 		fi
 	else
 		enable_static=yes
+		LIBTALLOC_TARGET=$LIBTALLOC_STATIC_TARGET
 		{ echo "$as_me:$LINENO: result: no shared library support -- will supply static library" >&5
 echo "${ECHO_T}no shared library support -- will supply static library" >&6; }
 	fi
@@ -67680,7 +67714,8 @@
 LIBTDB_STATIC_TARGET=bin/libtdb.a
 LIBTDB_SHARED=
 LIBTDB_STATIC=
-LIBTDB_LIBS=
+LIBTDB_LIBS=-ltdb
+LIBTDB_TARGET=
 INSTALL_LIBTDB=
 UNINSTALL_LIBTDB=
 
@@ -67695,6 +67730,7 @@
 
 
 
+
 { echo "$as_me:$LINENO: checking whether to build the libtdb shared library" >&5
 echo $ECHO_N "checking whether to build the libtdb shared library... $ECHO_C" >&6; }
 
@@ -67729,15 +67765,17 @@
 	UNINSTALL_LIBTDB=uninstalllibtdb
 	if eval $BLDSHARED = true; then
 		LIBTDB_SHARED=$LIBTDB_SHARED_TARGET
+		LIBTDB_TARGET=$LIBTDB_SHARED_TARGET
 		{ echo "$as_me:$LINENO: result: yes" >&5
 echo "${ECHO_T}yes" >&6; }
 		if test x"$USESHARED" != x"true" -o x"$LINK_LIBTDB" = "xSTATIC" ; then
 			enable_static=yes
-		else
-			LIBTDB_LIBS=-ltdb
+			LIBTDB_TARGET=$LIBTDB_STATIC_TARGET
+			LIBTDB_LIBS=$LIBTDB_STATIC_TARGET
 		fi
 	else
 		enable_static=yes
+		LIBTDB_TARGET=$LIBTDB_STATIC_TARGET
 		{ echo "$as_me:$LINENO: result: no shared library support -- will supply static library" >&5
 echo "${ECHO_T}no shared library support -- will supply static library" >&6; }
 	fi
@@ -67764,7 +67802,8 @@
 LIBNETAPI_STATIC_TARGET=bin/libnetapi.a
 LIBNETAPI_SHARED=
 LIBNETAPI_STATIC=
-LIBNETAPI_LIBS=
+LIBNETAPI_LIBS=-lnetapi
+LIBNETAPI_TARGET=
 INSTALL_LIBNETAPI=
 UNINSTALL_LIBNETAPI=
 
@@ -67779,6 +67818,7 @@
 
 
 
+
 { echo "$as_me:$LINENO: checking whether to build the libnetapi shared library" >&5
 echo $ECHO_N "checking whether to build the libnetapi shared library... $ECHO_C" >&6; }
 
@@ -67813,15 +67853,17 @@
 	UNINSTALL_LIBNETAPI=uninstalllibnetapi
 	if eval $BLDSHARED = true; then
 		LIBNETAPI_SHARED=$LIBNETAPI_SHARED_TARGET
+		LIBNETAPI_TARGET=$LIBNETAPI_SHARED_TARGET
 		{ echo "$as_me:$LINENO: result: yes" >&5
 echo "${ECHO_T}yes" >&6; }
 		if test x"$USESHARED" != x"true" -o x"$LINK_LIBNETAPI" = "xSTATIC" ; then
 			enable_static=yes
-		else
-			LIBNETAPI_LIBS=-lnetapi
+			LIBNETAPI_TARGET=$LIBNETAPI_STATIC_TARGET
+			LIBNETAPI_LIBS=$LIBNETAPI_STATIC_TARGET
 		fi
 	else
 		enable_static=yes
+		LIBNETAPI_TARGET=$LIBNETAPI_STATIC_TARGET
 		{ echo "$as_me:$LINENO: result: no shared library support -- will supply static library" >&5
 echo "${ECHO_T}no shared library support -- will supply static library" >&6; }
 	fi
@@ -67848,7 +67890,8 @@
 LIBSMBCLIENT_STATIC_TARGET=bin/libsmbclient.a
 LIBSMBCLIENT_SHARED=
 LIBSMBCLIENT_STATIC=
-LIBSMBCLIENT_LIBS=
+LIBSMBCLIENT_LIBS=-lsmbclient
+LIBSMBCLIENT_TARGET=
 INSTALL_LIBSMBCLIENT=
 UNINSTALL_LIBSMBCLIENT=
 
@@ -67863,6 +67906,7 @@
 
 
 
+
 { echo "$as_me:$LINENO: checking whether to build the libsmbclient shared library" >&5
 echo $ECHO_N "checking whether to build the libsmbclient shared library... $ECHO_C" >&6; }
 
@@ -67897,15 +67941,17 @@
 	UNINSTALL_LIBSMBCLIENT=uninstalllibsmbclient
 	if eval $BLDSHARED = true; then
 		LIBSMBCLIENT_SHARED=$LIBSMBCLIENT_SHARED_TARGET
+		LIBSMBCLIENT_TARGET=$LIBSMBCLIENT_SHARED_TARGET
 		{ echo "$as_me:$LINENO: result: yes" >&5
 echo "${ECHO_T}yes" >&6; }
 		if test x"$USESHARED" != x"true" -o x"$LINK_LIBSMBCLIENT" = "xSTATIC" ; then
 			enable_static=yes
-		else
-			LIBSMBCLIENT_LIBS=-lsmbclient
+			LIBSMBCLIENT_TARGET=$LIBSMBCLIENT_STATIC_TARGET
+			LIBSMBCLIENT_LIBS=$LIBSMBCLIENT_STATIC_TARGET
 		fi
 	else
 		enable_static=yes
+		LIBSMBCLIENT_TARGET=$LIBSMBCLIENT_STATIC_TARGET
 		{ echo "$as_me:$LINENO: result: no shared library support -- will supply static library" >&5
 echo "${ECHO_T}no shared library support -- will supply static library" >&6; }
 	fi
@@ -67932,7 +67978,8 @@
 LIBSMBSHAREMODES_STATIC_TARGET=bin/libsmbsharemodes.a
 LIBSMBSHAREMODES_SHARED=
 LIBSMBSHAREMODES_STATIC=
-LIBSMBSHAREMODES_LIBS=
+LIBSMBSHAREMODES_LIBS=-lsmbsharemodes
+LIBSMBSHAREMODES_TARGET=
 INSTALL_LIBSMBSHAREMODES=
 UNINSTALL_LIBSMBSHAREMODES=
 
@@ -67947,6 +67994,7 @@
 
 
 
+
 { echo "$as_me:$LINENO: checking whether to build the libsmbsharemodes shared library" >&5
 echo $ECHO_N "checking whether to build the libsmbsharemodes shared library... $ECHO_C" >&6; }
 
@@ -67981,15 +68029,17 @@
 	UNINSTALL_LIBSMBSHAREMODES=uninstalllibsmbsharemodes
 	if eval $BLDSHARED = true; then
 		LIBSMBSHAREMODES_SHARED=$LIBSMBSHAREMODES_SHARED_TARGET
+		LIBSMBSHAREMODES_TARGET=$LIBSMBSHAREMODES_SHARED_TARGET
 		{ echo "$as_me:$LINENO: result: yes" >&5
 echo "${ECHO_T}yes" >&6; }
 		if test x"$USESHARED" != x"true" -o x"$LINK_LIBSMBSHAREMODES" = "xSTATIC" ; then
 			enable_static=yes
-		else
-			LIBSMBSHAREMODES_LIBS=-lsmbsharemodes
+			LIBSMBSHAREMODES_TARGET=$LIBSMBSHAREMODES_STATIC_TARGET
+			LIBSMBSHAREMODES_LIBS=$LIBSMBSHAREMODES_STATIC_TARGET
 		fi
 	else
 		enable_static=yes
+		LIBSMBSHAREMODES_TARGET=$LIBSMBSHAREMODES_STATIC_TARGET
 		{ echo "$as_me:$LINENO: result: no shared library support -- will supply static library" >&5
 echo "${ECHO_T}no shared library support -- will supply static library" >&6; }
 	fi
@@ -68016,7 +68066,8 @@
 LIBADDNS_STATIC_TARGET=bin/libaddns.a
 LIBADDNS_SHARED=
 LIBADDNS_STATIC=
-LIBADDNS_LIBS=
+LIBADDNS_LIBS=-laddns
+LIBADDNS_TARGET=
 INSTALL_LIBADDNS=
 UNINSTALL_LIBADDNS=
 
@@ -68031,6 +68082,7 @@
 
 
 
+
 { echo "$as_me:$LINENO: checking whether to build the libaddns shared library" >&5
 echo $ECHO_N "checking whether to build the libaddns shared library... $ECHO_C" >&6; }
 
@@ -68067,15 +68119,17 @@
 	UNINSTALL_LIBADDNS=uninstalllibaddns
 	if eval $BLDSHARED = true; then
 		LIBADDNS_SHARED=$LIBADDNS_SHARED_TARGET
+		LIBADDNS_TARGET=$LIBADDNS_SHARED_TARGET
 		{ echo "$as_me:$LINENO: result: yes" >&5
 echo "${ECHO_T}yes" >&6; }
 		if test x"$USESHARED" != x"true" -o x"$LINK_LIBADDNS" = "xSTATIC" ; then
 			enable_static=yes
-		else
-			LIBADDNS_LIBS=-laddns
+			LIBADDNS_TARGET=$LIBADDNS_STATIC_TARGET
+			LIBADDNS_LIBS=$LIBADDNS_STATIC_TARGET
 		fi
 	else
 		enable_static=yes
+		LIBADDNS_TARGET=$LIBADDNS_STATIC_TARGET
 		{ echo "$as_me:$LINENO: result: no shared library support -- will supply static library" >&5
 echo "${ECHO_T}no shared library support -- will supply static library" >&6; }
 	fi
@@ -70148,7 +70202,7 @@
 echo "${ECHO_T}yes" >&6; };
 
 	case "$host_os" in
-	*linux*)
+	linux*-gnu* | gnu* | k*bsd*-gnu)
 		{ echo "$as_me:$LINENO: checking for linux sendfile64 support" >&5
 echo $ECHO_N "checking for linux sendfile64 support... $ECHO_C" >&6; }
 if test "${samba_cv_HAVE_SENDFILE64+set}" = set; then
@@ -71356,11 +71410,11 @@
 WINBIND_NSS_PTHREAD=""
 
 case "$host_os" in
-	*linux*)
+	linux*-gnu* | gnu* | k*bsd*-gnu)
 		NSSSONAMEVERSIONSUFFIX=".2"
 		WINBIND_NSS_EXTRA_OBJS="nsswitch/winbind_nss_linux.o"
 		;;
-	*freebsd[5-9]*)
+	freebsd5*|*freebsd[6-9]*)
 		# FreeBSD winbind client is implemented as a wrapper around
 		# the Linux version.
 		NSSSONAMEVERSIONSUFFIX=".1"
@@ -77544,6 +77598,7 @@
 LIBTALLOC_SHARED!$LIBTALLOC_SHARED$ac_delim
 LIBTALLOC_STATIC!$LIBTALLOC_STATIC$ac_delim
 LIBTALLOC_LIBS!$LIBTALLOC_LIBS$ac_delim
+LIBTALLOC_TARGET!$LIBTALLOC_TARGET$ac_delim
 INSTALL_LIBTALLOC!$INSTALL_LIBTALLOC$ac_delim
 UNINSTALL_LIBTALLOC!$UNINSTALL_LIBTALLOC$ac_delim
 LIBTALLOC_SOVER!$LIBTALLOC_SOVER$ac_delim
@@ -77552,6 +77607,7 @@
 LIBTDB_SHARED!$LIBTDB_SHARED$ac_delim
 LIBTDB_STATIC!$LIBTDB_STATIC$ac_delim
 LIBTDB_LIBS!$LIBTDB_LIBS$ac_delim
+LIBTDB_TARGET!$LIBTDB_TARGET$ac_delim
 INSTALL_LIBTDB!$INSTALL_LIBTDB$ac_delim
 UNINSTALL_LIBTDB!$UNINSTALL_LIBTDB$ac_delim
 LIBTDB_SOVER!$LIBTDB_SOVER$ac_delim
@@ -77560,9 +77616,7 @@
 LIBNETAPI_SHARED!$LIBNETAPI_SHARED$ac_delim
 LIBNETAPI_STATIC!$LIBNETAPI_STATIC$ac_delim
 LIBNETAPI_LIBS!$LIBNETAPI_LIBS$ac_delim
-INSTALL_LIBNETAPI!$INSTALL_LIBNETAPI$ac_delim
-UNINSTALL_LIBNETAPI!$UNINSTALL_LIBNETAPI$ac_delim
-LIBNETAPI_SOVER!$LIBNETAPI_SOVER$ac_delim
+LIBNETAPI_TARGET!$LIBNETAPI_TARGET$ac_delim
 _ACEOF
 
   if test `sed -n "s/.*$ac_delim\$/X/p" conf$$subs.sed | grep -c X` = 97; then
@@ -77604,11 +77658,15 @@
 ac_delim='%!_!# '
 for ac_last_try in false false false false false :; do
   cat >conf$$subs.sed <<_ACEOF
+INSTALL_LIBNETAPI!$INSTALL_LIBNETAPI$ac_delim
+UNINSTALL_LIBNETAPI!$UNINSTALL_LIBNETAPI$ac_delim
+LIBNETAPI_SOVER!$LIBNETAPI_SOVER$ac_delim
 LIBSMBCLIENT_SHARED_TARGET!$LIBSMBCLIENT_SHARED_TARGET$ac_delim
 LIBSMBCLIENT_STATIC_TARGET!$LIBSMBCLIENT_STATIC_TARGET$ac_delim
 LIBSMBCLIENT_SHARED!$LIBSMBCLIENT_SHARED$ac_delim
 LIBSMBCLIENT_STATIC!$LIBSMBCLIENT_STATIC$ac_delim
 LIBSMBCLIENT_LIBS!$LIBSMBCLIENT_LIBS$ac_delim
+LIBSMBCLIENT_TARGET!$LIBSMBCLIENT_TARGET$ac_delim
 INSTALL_LIBSMBCLIENT!$INSTALL_LIBSMBCLIENT$ac_delim
 UNINSTALL_LIBSMBCLIENT!$UNINSTALL_LIBSMBCLIENT$ac_delim
 LIBSMBCLIENT_SOVER!$LIBSMBCLIENT_SOVER$ac_delim
@@ -77617,6 +77675,7 @@
 LIBSMBSHAREMODES_SHARED!$LIBSMBSHAREMODES_SHARED$ac_delim
 LIBSMBSHAREMODES_STATIC!$LIBSMBSHAREMODES_STATIC$ac_delim
 LIBSMBSHAREMODES_LIBS!$LIBSMBSHAREMODES_LIBS$ac_delim
+LIBSMBSHAREMODES_TARGET!$LIBSMBSHAREMODES_TARGET$ac_delim
 INSTALL_LIBSMBSHAREMODES!$INSTALL_LIBSMBSHAREMODES$ac_delim
 UNINSTALL_LIBSMBSHAREMODES!$UNINSTALL_LIBSMBSHAREMODES$ac_delim
 LIBSMBSHAREMODES_SOVER!$LIBSMBSHAREMODES_SOVER$ac_delim
@@ -77625,6 +77684,7 @@
 LIBADDNS_SHARED!$LIBADDNS_SHARED$ac_delim
 LIBADDNS_STATIC!$LIBADDNS_STATIC$ac_delim
 LIBADDNS_LIBS!$LIBADDNS_LIBS$ac_delim
+LIBADDNS_TARGET!$LIBADDNS_TARGET$ac_delim
 INSTALL_LIBADDNS!$INSTALL_LIBADDNS$ac_delim
 UNINSTALL_LIBADDNS!$UNINSTALL_LIBADDNS$ac_delim
 LIBADDNS_SOVER!$LIBADDNS_SOVER$ac_delim
@@ -77664,7 +77724,7 @@
 LTLIBOBJS!$LTLIBOBJS$ac_delim
 _ACEOF
 
-  if test `sed -n "s/.*$ac_delim\$/X/p" conf$$subs.sed | grep -c X` = 58; then
+  if test `sed -n "s/.*$ac_delim\$/X/p" conf$$subs.sed | grep -c X` = 64; then
     break
   elif $ac_last_try; then
     { { echo "$as_me:$LINENO: error: could not make $CONFIG_STATUS" >&5
Index: samba-3.3.0rc1/source/include/config.h.in
===================================================================
--- samba-3.3.0rc1.orig/source/include/config.h.in
+++ samba-3.3.0rc1/source/include/config.h.in
@@ -66,6 +66,9 @@
 /* Whether to use fully FHS-compatible paths */
 #undef FHS_COMPATIBLE
 
+/* Whether to use fully FHS-compatible paths */
+#undef FHS_COMPATIBLE
+
 /* Whether the host os is FreeBSD */
 #undef FREEBSD
 
