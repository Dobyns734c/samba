From eb54b01fb0ad211a386278152c57d65fb081a5d6 Mon Sep 17 00:00:00 2001
From: Jeff Layton <jlayton@redhat.com>
Date: Tue, 26 Jan 2010 09:16:39 -0500
Subject: [PATCH 5/7] mount.cifs: take extra care that mountpoint isn't changed during mount

It's possible to trick mount.cifs into mounting onto the wrong directory
by replacing the mountpoint with a symlink to a directory. mount.cifs
attempts to check the validity of the mountpoint, but there's still a
possible race between those checks and the mount(2) syscall.

To guard against this, chdir to the mountpoint very early, and only deal
with it as "." from then on out.

Signed-off-by: Jeff Layton <jlayton@redhat.com>
---
 source/client/mount.cifs.c |   34 ++++++++++++++++++++++++++--------
 1 files changed, 26 insertions(+), 8 deletions(-)

Index: lenny/source/client/mount.cifs.c
===================================================================
--- lenny.orig/source/client/mount.cifs.c
+++ lenny/source/client/mount.cifs.c
@@ -1385,7 +1385,7 @@
 			fprintf(stderr, ",pass=********");
 	}
 
-	if(mount(dev_name, mountpoint, "cifs", flags, options)) {
+	if(mount(dev_name, ".", "cifs", flags, options)) {
 	/* remember to kill daemon on error */
 		switch (errno) {
 		case 0:
