From d747372d28273542298f86530e715e8faaf907f2 Mon Sep 17 00:00:00 2001
From: Samuel Cabrero <scabrero@zentyal.com>
Date: Fri, 4 Jul 2014 12:45:59 +0200
Subject: [PATCH 1/2] idl:drsuapi: Manage all possible lengths of
 drsuapi_DsBindInfo

Signed-off-by: Samuel Cabrero <scabrero@zentyal.com>
Reviewed-by: Kamen Mazdrashki <kamenim@samba.org>
Reviewed-by: Andrew Bartlett <abartlet@samba.org>
Reviewed-by: Kamen Mazdrashki <kamenim@samba.org>
---
 librpc/idl/drsuapi.idl                | 21 +++++++++++++++++++++
 source3/libnet/libnet_dssync.c        | 21 ++++++++++++++++++++-
 source3/rpcclient/cmd_drsuapi.c       |  4 ++++
 source4/dsdb/repl/drepl_out_helpers.c | 27 ++++++++++++++++++++++++++-
 source4/libnet/libnet_become_dc.c     | 25 ++++++++++++++++++++++++-
 source4/libnet/libnet_unbecome_dc.c   | 25 ++++++++++++++++++++++++-
 source4/torture/drs/rpc/dssync.c      | 21 ++++++++++++++++++++-
 source4/torture/drs/rpc/msds_intid.c  | 21 ++++++++++++++++++++-
 source4/torture/rpc/dsgetinfo.c       | 21 ++++++++++++++++++++-
 9 files changed, 179 insertions(+), 7 deletions(-)

Index: samba/librpc/idl/drsuapi.idl
===================================================================
--- samba.orig/librpc/idl/drsuapi.idl	2014-07-24 10:48:22.863853985 +0200
+++ samba/librpc/idl/drsuapi.idl	2014-07-24 10:49:17.531852056 +0200
@@ -129,6 +129,14 @@
 		uint32 repl_epoch;
 	} drsuapi_DsBindInfo28;
 
+	typedef [public] struct {
+		drsuapi_SupportedExtensions supported_extensions;
+		GUID site_guid;
+		uint32 pid;
+		uint32 repl_epoch;
+		drsuapi_SupportedExtensionsExt supported_extensions_ext;
+	} drsuapi_DsBindInfo32;
+
 	/* this is used by w2k8 */
 	typedef struct {
 		drsuapi_SupportedExtensions supported_extensions;
@@ -139,6 +147,17 @@
 		GUID config_dn_guid;
 	} drsuapi_DsBindInfo48;
 
+	/* this is used by w2k12 R2 [MS-DRSR] Section 5.39 */
+	typedef [public] struct {
+		drsuapi_SupportedExtensions supported_extensions;
+		GUID site_guid;
+		uint32 pid;
+		uint32 repl_epoch;
+		drsuapi_SupportedExtensionsExt supported_extensions_ext;
+		GUID config_dn_guid;
+		drsuapi_SupportedExtensionsExt supported_capabilities_ext;
+	} drsuapi_DsBindInfo52;
+
 	typedef struct {
 		[flag(NDR_REMAINING)] DATA_BLOB info;
 	} drsuapi_DsBindInfoFallBack;
@@ -146,7 +165,9 @@
 	typedef [nodiscriminant] union {
 		[case(24)][subcontext(4)] drsuapi_DsBindInfo24 info24;
 		[case(28)][subcontext(4)] drsuapi_DsBindInfo28 info28;
+		[case(32)][subcontext(4)] drsuapi_DsBindInfo32 info32;
 		[case(48)][subcontext(4)] drsuapi_DsBindInfo48 info48;
+		[case(52)][subcontext(4)] drsuapi_DsBindInfo52 info52;
 		[default][subcontext(4)] drsuapi_DsBindInfoFallBack FallBack;
 	} drsuapi_DsBindInfo;
 
Index: samba/source3/libnet/libnet_dssync.c
===================================================================
--- samba.orig/source3/libnet/libnet_dssync.c	2014-07-24 10:48:22.863853985 +0200
+++ samba/source3/libnet/libnet_dssync.c	2014-07-24 10:48:22.851853986 +0200
@@ -195,9 +195,19 @@
 		ctx->remote_info28.repl_epoch		= 0;
 		break;
 	}
-	case 28:
+	case 28: {
 		ctx->remote_info28 = bind_info.info.info28;
 		break;
+	}
+	case 32: {
+		struct drsuapi_DsBindInfo32 *info32;
+		info32 = &bind_info.info.info32;
+		ctx->remote_info28.site_guid		= info32->site_guid;
+		ctx->remote_info28.supported_extensions	= info32->supported_extensions;
+		ctx->remote_info28.pid			= info32->pid;
+		ctx->remote_info28.repl_epoch		= info32->repl_epoch;
+		break;
+	}
 	case 48: {
 		struct drsuapi_DsBindInfo48 *info48;
 		info48 = &bind_info.info.info48;
@@ -207,6 +217,15 @@
 		ctx->remote_info28.repl_epoch		= info48->repl_epoch;
 		break;
 	}
+	case 52: {
+		struct drsuapi_DsBindInfo52 *info52;
+		info52 = &bind_info.info.info52;
+		ctx->remote_info28.site_guid		= info52->site_guid;
+		ctx->remote_info28.supported_extensions	= info52->supported_extensions;
+		ctx->remote_info28.pid			= info52->pid;
+		ctx->remote_info28.repl_epoch		= info52->repl_epoch;
+		break;
+	}
 	default:
 		DEBUG(1, ("Warning: invalid info length in bind info: %d\n",
 			  bind_info.length));
Index: samba/source3/rpcclient/cmd_drsuapi.c
===================================================================
--- samba.orig/source3/rpcclient/cmd_drsuapi.c	2014-07-24 10:48:22.863853985 +0200
+++ samba/source3/rpcclient/cmd_drsuapi.c	2014-07-24 10:48:22.851853986 +0200
@@ -420,8 +420,12 @@
 		supported_extensions = bind_info.info.info24.supported_extensions;
 	} else if (bind_info.length == 28) {
 		supported_extensions = bind_info.info.info28.supported_extensions;
+	} else if (bind_info.length == 32) {
+		supported_extensions = bind_info.info.info32.supported_extensions;
 	} else if (bind_info.length == 48) {
 		supported_extensions = bind_info.info.info48.supported_extensions;
+	} else if (bind_info.length == 52) {
+		supported_extensions = bind_info.info.info52.supported_extensions;
 	}
 
 	if (!nc_dn) {
Index: samba/source4/dsdb/repl/drepl_out_helpers.c
===================================================================
--- samba.orig/source4/dsdb/repl/drepl_out_helpers.c	2014-07-24 10:48:22.863853985 +0200
+++ samba/source4/dsdb/repl/drepl_out_helpers.c	2014-07-24 10:48:29.000000000 +0200
@@ -183,10 +183,35 @@
 			info28->repl_epoch		= info48->repl_epoch;
 			break;
 		}
-		case 28:
+		case 28: {
 			*info28 = state->bind_r.out.bind_info->info.info28;
 			break;
 		}
+		case 32: {
+			struct drsuapi_DsBindInfo32 *info32;
+			info32 = &state->bind_r.out.bind_info->info.info32;
+
+			info28->supported_extensions	= info32->supported_extensions;
+			info28->site_guid		= info32->site_guid;
+			info28->pid			= info32->pid;
+			info28->repl_epoch		= info32->repl_epoch;
+			break;
+		}
+		case 52: {
+			struct drsuapi_DsBindInfo52 *info52;
+			info52 = &state->bind_r.out.bind_info->info.info52;
+
+			info28->supported_extensions	= info52->supported_extensions;
+			info28->site_guid		= info52->site_guid;
+			info28->pid			= info52->pid;
+			info28->repl_epoch		= info52->repl_epoch;
+			break;
+		}
+		default:
+			DEBUG(1, ("Warning: invalid info length in bind info: %d\n",
+				state->bind_r.out.bind_info->length));
+			break;
+		}
 	}
 
 	tevent_req_done(req);
Index: samba/source4/libnet/libnet_become_dc.c
===================================================================
--- samba.orig/source4/libnet/libnet_become_dc.c	2014-07-24 10:48:22.863853985 +0200
+++ samba/source4/libnet/libnet_become_dc.c	2014-07-24 10:48:29.000000000 +0200
@@ -1708,10 +1708,33 @@
 			drsuapi->remote_info28.repl_epoch		= info48->repl_epoch;
 			break;
 		}
-		case 28:
+		case 28: {
 			drsuapi->remote_info28 = drsuapi->bind_r.out.bind_info->info.info28;
 			break;
 		}
+		case 32: {
+			struct drsuapi_DsBindInfo32 *info32;
+			info32 = &drsuapi->bind_r.out.bind_info->info.info32;
+			drsuapi->remote_info28.supported_extensions	= info32->supported_extensions;
+			drsuapi->remote_info28.site_guid		= info32->site_guid;
+			drsuapi->remote_info28.pid			= info32->pid;
+			drsuapi->remote_info28.repl_epoch		= info32->repl_epoch;
+			break;
+		}
+		case 52: {
+			struct drsuapi_DsBindInfo52 *info52;
+			info52 = &drsuapi->bind_r.out.bind_info->info.info52;
+			drsuapi->remote_info28.supported_extensions	= info52->supported_extensions;
+			drsuapi->remote_info28.site_guid		= info52->site_guid;
+			drsuapi->remote_info28.pid			= info52->pid;
+			drsuapi->remote_info28.repl_epoch		= info52->repl_epoch;
+			break;
+		}
+		default:
+			DEBUG(1, ("Warning: invalid info length in bind info: %d\n",
+					drsuapi->bind_r.out.bind_info->length));
+			break;
+		}
 	}
 
 	return WERR_OK;
Index: samba/source4/libnet/libnet_unbecome_dc.c
===================================================================
--- samba.orig/source4/libnet/libnet_unbecome_dc.c	2014-07-24 10:48:22.863853985 +0200
+++ samba/source4/libnet/libnet_unbecome_dc.c	2014-07-24 10:48:29.000000000 +0200
@@ -644,10 +644,33 @@
 			s->drsuapi.remote_info28.repl_epoch		= info48->repl_epoch;
 			break;
 		}
-		case 28:
+		case 28: {
 			s->drsuapi.remote_info28 = s->drsuapi.bind_r.out.bind_info->info.info28;
 			break;
 		}
+		case 32: {
+			struct drsuapi_DsBindInfo32 *info32;
+			info32 = &s->drsuapi.bind_r.out.bind_info->info.info32;
+			s->drsuapi.remote_info28.supported_extensions	= info32->supported_extensions;
+			s->drsuapi.remote_info28.site_guid		= info32->site_guid;
+			s->drsuapi.remote_info28.pid			= info32->pid;
+			s->drsuapi.remote_info28.repl_epoch		= info32->repl_epoch;
+			break;
+		}
+		case 52: {
+			struct drsuapi_DsBindInfo52 *info52;
+			info52 = &s->drsuapi.bind_r.out.bind_info->info.info52;
+			s->drsuapi.remote_info28.supported_extensions	= info52->supported_extensions;
+			s->drsuapi.remote_info28.site_guid		= info52->site_guid;
+			s->drsuapi.remote_info28.pid			= info52->pid;
+			s->drsuapi.remote_info28.repl_epoch		= info52->repl_epoch;
+			break;
+		}
+		default:
+			DEBUG(1, ("Warning: invalid info length in bind info: %d\n",
+				s->drsuapi.bind_r.out.bind_info->length));
+			break;
+		}
 	}
 
 	unbecomeDC_drsuapi_remove_ds_server_send(s);
Index: samba/source4/torture/drs/rpc/dssync.c
===================================================================
--- samba.orig/source4/torture/drs/rpc/dssync.c	2014-07-24 10:48:22.863853985 +0200
+++ samba/source4/torture/drs/rpc/dssync.c	2014-07-24 10:48:29.000000000 +0200
@@ -238,9 +238,28 @@
 			b->peer_bind_info28.repl_epoch		= info48->repl_epoch;
 			break;
 		}
-		case 28:
+		case 28: {
 			b->peer_bind_info28 = b->req.out.bind_info->info.info28;
 			break;
+		}
+		case 32: {
+			struct drsuapi_DsBindInfo32 *info32;
+			info32 = &b->req.out.bind_info->info.info32;
+			b->peer_bind_info28.supported_extensions= info32->supported_extensions;
+			b->peer_bind_info28.site_guid		= info32->site_guid;
+			b->peer_bind_info28.pid			= info32->pid;
+			b->peer_bind_info28.repl_epoch		= info32->repl_epoch;
+			break;
+		}
+		case 52: {
+			struct drsuapi_DsBindInfo52 *info52;
+			info52 = &b->req.out.bind_info->info.info52;
+			b->peer_bind_info28.supported_extensions= info52->supported_extensions;
+			b->peer_bind_info28.site_guid		= info52->site_guid;
+			b->peer_bind_info28.pid			= info52->pid;
+			b->peer_bind_info28.repl_epoch		= info52->repl_epoch;
+			break;
+		}
 		default:
 			printf("DsBind - warning: unknown BindInfo length: %u\n",
 			       b->req.out.bind_info->length);
Index: samba/source4/torture/drs/rpc/msds_intid.c
===================================================================
--- samba.orig/source4/torture/drs/rpc/msds_intid.c	2014-07-24 10:48:22.863853985 +0200
+++ samba/source4/torture/drs/rpc/msds_intid.c	2014-07-24 10:48:29.000000000 +0200
@@ -237,9 +237,28 @@
 		bi->srv_info48.repl_epoch		= info28->repl_epoch;
 		break;
 	}
-	case 48:
+	case 48: {
 		bi->srv_info48 = r.out.bind_info->info.info48;
 		break;
+	}
+	case 32: {
+		struct drsuapi_DsBindInfo32 *info32;
+		info32 = &r.out.bind_info->info.info32;
+		bi->srv_info48.supported_extensions	= info32->supported_extensions;
+		bi->srv_info48.site_guid		= info32->site_guid;
+		bi->srv_info48.pid			= info32->pid;
+		bi->srv_info48.repl_epoch		= info32->repl_epoch;
+		break;
+	}
+	case 52: {
+		struct drsuapi_DsBindInfo52 *info52;
+		info52 = &r.out.bind_info->info.info52;
+		bi->srv_info48.supported_extensions	= info52->supported_extensions;
+		bi->srv_info48.site_guid		= info52->site_guid;
+		bi->srv_info48.pid			= info52->pid;
+		bi->srv_info48.repl_epoch		= info52->repl_epoch;
+		break;
+	}
 	default:
 		torture_result(tctx, TORTURE_FAIL,
 		               "DsBind: unknown BindInfo length: %u",
Index: samba/source4/torture/rpc/dsgetinfo.c
===================================================================
--- samba.orig/source4/torture/rpc/dsgetinfo.c	2014-07-24 10:48:22.863853985 +0200
+++ samba/source4/torture/rpc/dsgetinfo.c	2014-07-24 10:48:29.000000000 +0200
@@ -200,9 +200,28 @@
 			b->peer_bind_info28.repl_epoch		= info48->repl_epoch;
 			break;
 		}
-		case 28:
+		case 28: {
 			b->peer_bind_info28 = b->req.out.bind_info->info.info28;
 			break;
+		}
+		case 32: {
+			struct drsuapi_DsBindInfo32 *info32;
+			info32 = &b->req.out.bind_info->info.info32;
+			b->peer_bind_info28.supported_extensions= info32->supported_extensions;
+			b->peer_bind_info28.site_guid		= info32->site_guid;
+			b->peer_bind_info28.pid			= info32->pid;
+			b->peer_bind_info28.repl_epoch		= info32->repl_epoch;
+			break;
+		}
+		case 52: {
+			struct drsuapi_DsBindInfo52 *info52;
+			info52 = &b->req.out.bind_info->info.info52;
+			b->peer_bind_info28.supported_extensions= info52->supported_extensions;
+			b->peer_bind_info28.site_guid		= info52->site_guid;
+			b->peer_bind_info28.pid			= info52->pid;
+			b->peer_bind_info28.repl_epoch		= info52->repl_epoch;
+			break;
+		}
 		default:
 			printf("DsBind - warning: unknown BindInfo length: %u\n",
 			       b->req.out.bind_info->length);
