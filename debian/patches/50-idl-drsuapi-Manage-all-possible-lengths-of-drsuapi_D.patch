From d747372d28273542298f86530e715e8faaf907f2 Mon Sep 17 00:00:00 2001
From: Samuel Cabrero <scabrero@zentyal.com>
Date: Fri, 4 Jul 2014 12:45:59 +0200
Subject: [PATCH 1/2] idl:drsuapi: Manage all possible lengths of
 drsuapi_DsBindInfo

Signed-off-by: Samuel Cabrero <scabrero@zentyal.com>
Reviewed-by: Kamen Mazdrashki <kamenim@samba.org>
Reviewed-by: Andrew Bartlett <abartlet@samba.org>
Reviewed-by: Kamen Mazdrashki <kamenim@samba.org>
---
 librpc/idl/drsuapi.idl                | 21 +++++++++++++++++++++
 source3/libnet/libnet_dssync.c        | 21 ++++++++++++++++++++-
 source3/rpcclient/cmd_drsuapi.c       |  4 ++++
 source4/dsdb/repl/drepl_out_helpers.c | 27 ++++++++++++++++++++++++++-
 source4/libnet/libnet_become_dc.c     | 25 ++++++++++++++++++++++++-
 source4/libnet/libnet_unbecome_dc.c   | 25 ++++++++++++++++++++++++-
 source4/torture/drs/rpc/dssync.c      | 21 ++++++++++++++++++++-
 source4/torture/drs/rpc/msds_intid.c  | 21 ++++++++++++++++++++-
 source4/torture/rpc/dsgetinfo.c       | 21 ++++++++++++++++++++-
 9 files changed, 179 insertions(+), 7 deletions(-)

Index: samba/librpc/idl/drsuapi.idl
===================================================================
--- samba.orig/librpc/idl/drsuapi.idl	2015-02-24 18:29:44.975472956 +0100
+++ samba/librpc/idl/drsuapi.idl	2015-02-24 18:29:44.967472956 +0100
@@ -137,6 +137,14 @@
 		drsuapi_SupportedExtensionsExt supported_extensions_ext;
 	} drsuapi_DsBindInfo32;
 
+	typedef [public] struct {
+		drsuapi_SupportedExtensions supported_extensions;
+		GUID site_guid;
+		uint32 pid;
+		uint32 repl_epoch;
+		drsuapi_SupportedExtensionsExt supported_extensions_ext;
+	} drsuapi_DsBindInfo32;
+
 	/* this is used by w2k8 */
 	typedef [public] struct {
 		drsuapi_SupportedExtensions supported_extensions;
@@ -261,6 +269,17 @@
 		[charset(UTF16),size_is(__ndr_size_dn+1)] uint16 dn[];
 	} drsuapi_DsReplicaObjectIdentifier;
 
+	/* this is used by w2k12 R2 [MS-DRSR] Section 5.39 */
+	typedef [public] struct {
+		drsuapi_SupportedExtensions supported_extensions;
+		GUID site_guid;
+		uint32 pid;
+		uint32 repl_epoch;
+		drsuapi_SupportedExtensionsExt supported_extensions_ext;
+		GUID config_dn_guid;
+		drsuapi_SupportedExtensionsExt supported_capabilities_ext;
+	} drsuapi_DsBindInfo52;
+
 	typedef struct {
 		[ref] drsuapi_DsReplicaObjectIdentifier *naming_context;
 		GUID source_dsa_guid;
